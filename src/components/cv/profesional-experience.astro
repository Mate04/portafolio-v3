---
import type { ExperienciaLaboral } from "../../data/info.type";
import { getLangFromUrl, useTranslations } from "../../utils/languaje.utils";
import Section from "./section-cv.astro";

interface Props {
  experienciaLaboral: ExperienciaLaboral;
}

const { experienciaLaboral } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Util para formatear las fechas tipo "MM, YY" -> "Mes YYYY"
function formatDate(raw: string) {
  const lower = raw.toLowerCase().trim();
  if (lower === "actualidad" || lower === "present") {
    return lang === "en" ? "Present" : "Actualidad";
  }
  if (/^\d{2},\s?\d{2}$/.test(raw)) {
    const [mm, yy] = raw.split(",").map((s) => s.trim());
    const monthIndex = parseInt(mm, 10) - 1;
    const year = parseInt(yy, 10) < 50 ? "20" + yy : "19" + yy;
    const monthsEs = [
      "Ene",
      "Feb",
      "Mar",
      "Abr",
      "May",
      "Jun",
      "Jul",
      "Ago",
      "Sep",
      "Oct",
      "Nov",
      "Dic",
    ];
    const monthsEn = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    const m = lang === "en" ? monthsEn[monthIndex] : monthsEs[monthIndex];
    return `${m} ${year}`;
  }
  return raw.charAt(0).toUpperCase() + raw.slice(1);
}

function splitParagraphs(text: string) {
  return text
    .split(/\n+|(?<=\.)\s{2,}/)
    .map((p) => p.trim())
    .filter(Boolean);
}
---

<Section title={t("work-title")}>
  {
    experienciaLaboral.map(
      ({
        cargo,
        empresa,
        fechaDesde,
        fechaHasta,
        descripcionPuestoExtensa /*, habilidades */,
      }) => {
        const paragraphs = splitParagraphs(descripcionPuestoExtensa);
        return (
          <article class="group">
            <header class="flex flex-col gap-1 sm:flex-row sm:items-start sm:justify-between">
              <div>
                <h3 class="font-bold tracking-wide uppercase mb-2">
                  {empresa}
                </h3>
                <p class=" font-bold text-base leading-tight">{cargo}</p>
              </div>
              <div class="text-sm text-gray-600 font-medium mt-1 sm:mt-0 whitespace-nowrap">
                {formatDate(fechaDesde)} - {formatDate(fechaHasta)}
              </div>
            </header>
            <div class="mt-3 space-y-4 leading-relaxed text-base text-gray-700">
              {paragraphs.map((p) => (
                <p>{p}</p>
              ))}
            </div>
            {/* Habilidades: Descomentar si se desean mostrar chips */}
            {/* <ul class="mt-4 flex flex-wrap gap-2 print:hidden">
              {habilidades.map(h => (
                <li class="text-xs px-2 py-1 border border-gray-300 rounded-full text-gray-600 font-medium">{h}</li>
              ))}
            </ul> */}
          </article>
        );
      }
    )
  }
</Section>

<style>
  body {
    font-family: "Proxima Nova", sans-serif;
  }
</style>
